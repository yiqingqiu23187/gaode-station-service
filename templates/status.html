{% extends "base.html" %}

{% block title %}简历管理系统 - 处理状态{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-10 mx-auto">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2>
                <i class="bi bi-activity"></i>
                处理状态
            </h2>
            <a href="/" class="btn btn-outline-primary">
                <i class="bi bi-house"></i>
                返回首页
            </a>
        </div>

        <!-- 进度概览 -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-graph-up"></i>
                    处理进度
                </h5>
            </div>
            <div class="card-body">
                <div class="progress mb-3" style="height: 25px;">
                    <div class="progress-bar progress-bar-striped"
                         role="progressbar"
                         style="width: {{ status.progress }}%"
                         id="progressBar">
                        {{ status.progress }}%
                    </div>
                </div>
                <p class="mb-2" id="statusMessage">
                    <strong>当前状态：</strong>{{ status.message }}
                </p>
                <div id="countdownContainer" style="display: none;">
                    <p class="countdown mb-0">
                        <i class="bi bi-clock"></i>
                        剩余等待时间: <span id="countdown">--:--</span>
                    </p>
                </div>
            </div>
        </div>

        <!-- 步骤详情 -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-list-check"></i>
                    处理步骤
                </h5>
            </div>
            <div class="card-body">
                <div class="progress-step">
                    <div class="step-icon" id="step1">1</div>
                    <div>
                        <h6>简历入库</h6>
                        <p class="text-muted mb-0">将Excel中的简历数据导入到数据库</p>
                    </div>
                </div>
                <div class="progress-step">
                    <div class="step-icon" id="step2">2</div>
                    <div>
                        <h6>添加微信联系人</h6>
                        <p class="text-muted mb-0">根据手机号批量添加微信联系人</p>
                    </div>
                </div>
                <div class="progress-step">
                    <div class="step-icon" id="step3">3</div>
                    <div>
                        <h6>等待处理完成</h6>
                        <p class="text-muted mb-0">等待微信添加任务完成</p>
                    </div>
                </div>
                <div class="progress-step">
                    <div class="step-icon" id="step4">4</div>
                    <div>
                        <h6>添加外呼任务</h6>
                        <p class="text-muted mb-0">为每个简历创建外呼任务</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- 结果详情 -->
        <div id="resultsContainer">
            {% if status.results %}
                <!-- 简历导入结果 -->
                {% if status.results.import %}
                <div class="card result-card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="bi bi-database-check"></i>
                            简历导入结果
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3">
                                <div class="text-center">
                                    <h4 class="text-primary">{{ status.results.import.total_records }}</h4>
                                    <p class="text-muted">总记录数</p>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="text-center">
                                    <h4 class="text-success">{{ status.results.import.successful_count }}</h4>
                                    <p class="text-muted">成功导入</p>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="text-center">
                                    <h4 class="text-danger">{{ status.results.import.failed_count }}</h4>
                                    <p class="text-muted">导入失败</p>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="text-center">
                                    <h4 class="text-info">
                                        {{ "%.1f"|format((status.results.import.successful_count / status.results.import.total_records * 100) if status.results.import.total_records > 0 else 0) }}%
                                    </h4>
                                    <p class="text-muted">成功率</p>
                                </div>
                            </div>
                        </div>
                        {% if status.results.import.failed_records %}
                        <div class="mt-3">
                            <h6>失败记录：</h6>
                            <div class="table-responsive">
                                <table class="table table-sm">
                                    <thead>
                                        <tr>
                                            <th>行号</th>
                                            <th>姓名</th>
                                            <th>错误信息</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for record in status.results.import.failed_records %}
                                        <tr>
                                            <td>{{ record.row }}</td>
                                            <td>{{ record.name }}</td>
                                            <td class="text-danger">{{ record.error }}</td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% endif %}

                <!-- 微信添加结果 -->
                {% if status.results.wechat %}
                <div class="card result-card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="bi bi-wechat"></i>
                            微信联系人添加结果
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3">
                                <div class="text-center">
                                    <h4 class="text-primary">{{ status.results.wechat.total_contacts }}</h4>
                                    <p class="text-muted">总联系人</p>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="text-center">
                                    <h4 class="text-success">{{ status.results.wechat.successful_count }}</h4>
                                    <p class="text-muted">添加成功</p>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="text-center">
                                    <h4 class="text-danger">{{ status.results.wechat.failed_count }}</h4>
                                    <p class="text-muted">添加失败</p>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="text-center">
                                    <h4 class="text-warning">{{ status.results.wechat.estimated_wait_time }}s</h4>
                                    <p class="text-muted">预计等待</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}

                <!-- 外呼任务结果 -->
                {% if status.results.waihu %}
                <div class="card result-card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="bi bi-telephone"></i>
                            外呼任务创建结果
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3">
                                <div class="text-center">
                                    <h4 class="text-primary">{{ status.results.waihu.total_tasks }}</h4>
                                    <p class="text-muted">总任务数</p>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="text-center">
                                    <h4 class="text-success">{{ status.results.waihu.successful_count }}</h4>
                                    <p class="text-muted">创建成功</p>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="text-center">
                                    <h4 class="text-danger">{{ status.results.waihu.failed_count }}</h4>
                                    <p class="text-muted">创建失败</p>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="text-center">
                                    <h4 class="text-info">
                                        {{ "%.1f"|format((status.results.waihu.successful_count / status.results.waihu.total_tasks * 100) if status.results.waihu.total_tasks > 0 else 0) }}%
                                    </h4>
                                    <p class="text-muted">成功率</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}
            {% endif %}
        </div>

        <!-- 完成状态 -->
        {% if status.step == 'completed' %}
        <div class="card">
            <div class="card-body text-center">
                <i class="bi bi-check-circle-fill text-success" style="font-size: 4rem;"></i>
                <h3 class="mt-3 text-success">处理完成！</h3>
                <p class="text-muted">所有任务已成功完成，可以开始后续工作了。</p>
                <a href="/" class="btn btn-primary">
                    <i class="bi bi-arrow-repeat"></i>
                    处理新文件
                </a>
            </div>
        </div>
        {% elif status.step == 'error' %}
        <div class="card">
            <div class="card-body text-center">
                <i class="bi bi-exclamation-triangle-fill text-danger" style="font-size: 4rem;"></i>
                <h3 class="mt-3 text-danger">处理失败</h3>
                <p class="text-muted">{{ status.message }}</p>
                <a href="/" class="btn btn-primary">
                    <i class="bi bi-arrow-repeat"></i>
                    重新开始
                </a>
            </div>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    let countdownInterval;

    function updateStatus() {
        fetch('/api/status')
            .then(response => response.json())
            .then(data => {
                // 更新进度条
                const progressBar = document.getElementById('progressBar');
                progressBar.style.width = data.progress + '%';
                progressBar.textContent = data.progress + '%';

                // 更新状态消息
                document.getElementById('statusMessage').innerHTML =
                    '<strong>当前状态：</strong>' + data.message;

                // 更新步骤状态
                updateStepStatus(data.step);

                // 处理倒计时
                if (data.step === 'waiting' && data.wait_until) {
                    showCountdown(data.wait_until);
                } else {
                    hideCountdown();
                }

                // 如果进度条需要动画效果
                if (data.step === 'importing' || data.step === 'adding_wechat' || data.step === 'adding_waihu') {
                    progressBar.classList.add('progress-bar-animated');
                } else {
                    progressBar.classList.remove('progress-bar-animated');
                }

                // 如果完成或出错，停止轮询
                if (data.step === 'completed' || data.step === 'error') {
                    clearInterval(statusInterval);
                    if (data.step === 'completed') {
                        location.reload(); // 重新加载页面显示完整结果
                    }
                }
            })
            .catch(error => {
                console.error('获取状态失败:', error);
            });
    }

    function updateStepStatus(currentStep) {
        const steps = ['idle', 'importing', 'adding_wechat', 'waiting', 'adding_waihu', 'completed'];
        const currentIndex = steps.indexOf(currentStep);

        for (let i = 1; i <= 4; i++) {
            const stepElement = document.getElementById('step' + i);
            stepElement.className = 'step-icon';

            if (i < currentIndex || (currentStep === 'completed' && i <= 4)) {
                stepElement.classList.add('completed');
                stepElement.innerHTML = '<i class="bi bi-check"></i>';
            } else if (i === currentIndex - 1 || (currentStep === 'importing' && i === 1) ||
                      (currentStep === 'adding_wechat' && i === 2) ||
                      (currentStep === 'waiting' && i === 3) ||
                      (currentStep === 'adding_waihu' && i === 4)) {
                stepElement.classList.add('active');
                stepElement.innerHTML = i;
            } else if (currentStep === 'error') {
                stepElement.classList.add('error');
                stepElement.innerHTML = '<i class="bi bi-x"></i>';
            } else {
                stepElement.classList.add('pending');
                stepElement.innerHTML = i;
            }
        }
    }

    function showCountdown(waitUntil) {
        const countdownContainer = document.getElementById('countdownContainer');
        const countdownElement = document.getElementById('countdown');

        countdownContainer.style.display = 'block';

        if (countdownInterval) {
            clearInterval(countdownInterval);
        }

        countdownInterval = setInterval(function() {
            const now = new Date().getTime();
            const target = new Date(waitUntil).getTime();
            const distance = target - now;

            if (distance > 0) {
                const minutes = Math.floor(distance / (1000 * 60));
                const seconds = Math.floor((distance % (1000 * 60)) / 1000);

                countdownElement.textContent =
                    String(minutes).padStart(2, '0') + ':' + String(seconds).padStart(2, '0');
            } else {
                countdownElement.textContent = '00:00';
                clearInterval(countdownInterval);
            }
        }, 1000);
    }

    function hideCountdown() {
        const countdownContainer = document.getElementById('countdownContainer');
        countdownContainer.style.display = 'none';

        if (countdownInterval) {
            clearInterval(countdownInterval);
        }
    }

    // 初始化状态
    updateStepStatus('{{ status.step }}');

    // 如果正在处理，启动状态轮询
    {% if status.step not in ['idle', 'completed', 'error'] %}
    const statusInterval = setInterval(updateStatus, 2000);

    // 页面卸载时清理定时器
    window.addEventListener('beforeunload', function() {
        if (statusInterval) {
            clearInterval(statusInterval);
        }
        if (countdownInterval) {
            clearInterval(countdownInterval);
        }
    });
    {% endif %}

    // 如果有等待时间，显示倒计时
    {% if status.wait_until %}
    showCountdown('{{ status.wait_until }}');
    {% endif %}
});
</script>
{% endblock %}
