# 一键更新部署脚本使用说明

## 功能概述

`update_and_deploy.sh` 脚本实现了从本地CSV数据更新到远程服务器部署的完整自动化流程，包括：

1. ✅ 本地数据处理（添加坐标、创建数据库）
2. ✅ 项目打包
3. ✅ 上传到远程服务器
4. ✅ 远程Docker重新部署
5. ✅ 自动清理临时文件

## 使用步骤

### 1. 更新本地数据
手动更新项目目录中的 `岗位位置信息底表.csv` 文件

### 2. 执行一键部署
```bash
./update_and_deploy.sh
```

### 3. 等待完成
脚本会自动完成所有步骤，最终输出服务地址信息

## 脚本执行流程

```
检查本地环境 → 处理数据 → 打包项目 → 上传服务器 → 远程部署 → 清理文件
```

## 服务器配置

- **服务器IP**: 49.232.253.3
- **部署路径**: /opt/gaode-service
- **服务端口**: 17263
- **访问地址**: http://49.232.253.3:17263

## 注意事项

1. **环境要求**：
   - 本地需要安装 Python3
   - 自动安装 sshpass（用于SSH自动化）

2. **网络要求**：
   - 需要能够访问高德地图API（添加坐标时使用）
   - 需要能够SSH连接到远程服务器

3. **时间预估**：
   - 添加坐标：根据数据量，通常2-5分钟
   - 总体流程：通常5-10分钟

## 查看远程服务状态

```bash
# 查看服务日志
ssh root@49.232.253.3 'cd /opt/gaode-service && docker-compose logs -f'

# 查看服务状态
ssh root@49.232.253.3 'cd /opt/gaode-service && docker-compose ps'

# 重启服务（如需要）
ssh root@49.232.253.3 'cd /opt/gaode-service && docker-compose restart'
```

## 故障排除

### 1. SSH连接失败
- 检查服务器IP和密码是否正确
- 确认服务器SSH服务正常运行

### 2. 坐标添加失败  
- 检查网络连接
- 确认高德地图API可用

### 3. 远程部署失败
- 检查远程服务器Docker是否正常运行
- 查看远程服务器磁盘空间是否充足

## 手动回滚

如果需要回滚到之前版本：

```bash
ssh root@49.232.253.3
cd /opt/gaode-service
# 查看备份
ls -la backup.*
# 恢复备份（替换时间戳）
rm -rf ./* && cp -r backup.YYYYMMDD_HHMMSS/* ./
docker-compose up -d
``` 